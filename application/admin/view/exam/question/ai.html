<!-- view/exam/question/ai.html -->
<script src="__CDN__/assets/libs/jquery/dist/jquery.min.js"></script>

<style>
    .ai-gen-container {
        padding: 30px;
    }
    .ai-gen-container .title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 20px;
    }
    .ai-type-options label {
        margin-right: 30px;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .tag-sample {
        background: #f0f0f0;
        border-radius: 4px;
        display: inline-block;
        padding: 4px 10px;
        margin: 5px;
        font-size: 12px;
        cursor: pointer;
    }
    .question-counts input {
        width: 60px;
        text-align: center;
    }

    .option-list {
    list-style-type: upper-alpha; /* A, B, C, D */
    padding-left: 20px;           /* ä¿ç•™ç¼©è¿› */
    }

    .option-list li::marker {
    content: counter(list-item, upper-alpha) ". ";
    }

</style>

<div class="ai-gen-container">
    <div class="title">è¯·è®¾ç½®æ‚¨çš„å‘½é¢˜éœ€æ±‚</div>

    <form id="ai-form" role="form" method="post">
        <!-- å‘½é¢˜æ–¹å¼ -->
        <div class="form-group ai-type-options">
            <label><input type="radio" name="mode" value="knowledge" checked> æŒ‰å­¦ç§‘/çŸ¥è¯†ç‚¹/æ´»åŠ¨ç­‰ç”Ÿæˆé¢˜ç›®</label>
        </div>

        <div class="form-group">
            <label class="control-label col-xs-12 col-sm-2">{:__('Cate_id')}:</label>
            <div >
                <input id="c-cate_id" data-rule="required" data-source="exam/cate/selectpage" data-params='{"custom[kind]":"QUESTION","isTree":true}' class="form-control selectpage" name="row[cate_id]" type="text" value="" />
            </div>
        </div>
        <!-- å‘½é¢˜å†…å®¹è¾“å…¥ -->
        <div class="form-group">
            <textarea name="prompt" class="form-control" rows="5" maxlength="200"
                      placeholder="è¯·è¾“å…¥å­¦ç§‘ã€çŸ¥è¯†ç‚¹ã€æ´»åŠ¨ç­‰å†…å®¹ï¼ŒAIå°†è‡ªåŠ¨æŸ¥è¯¢ç›¸å…³èµ„æ–™å¹¶ä¸ºæ‚¨ç”Ÿæˆé¢˜ç›®ï¼"></textarea>
            <div class="help-block">
                ç¤ºä¾‹è¯•è¯•ï¼š
                <span class="tag-sample">è´¢ä¼šå¿…å¤‡çš„è´¢åŠ¡çŸ¥è¯†</span>
                <span class="tag-sample">ä¿é™©ä»£ç†äººæ‹œè®¿å®¢æˆ·çš„æŠ€å·§</span>
                <span class="tag-sample">æ˜¥èŠ‚çŸ¥è¯†ç«èµ›æ´»åŠ¨</span>
            </div>
        </div>
       
        <!-- é¢˜å‹æ•°é‡ -->
        <div class="form-group question-counts">
            <label>é¢˜ç›®æ•°é‡ï¼ˆæœ€å¤šå¯ç”Ÿæˆ25é¢˜ï¼‰ï¼š</label><br>
            <label>å•é€‰é¢˜ <input type="number" min="0" max="25" name="single" value="0"> </label>
            <label>å¤šé€‰é¢˜ <input type="number" min="0" max="25" name="multi" value="0"> </label>
            <label>åˆ¤æ–­é¢˜ <input type="number" min="0" max="25" name="judge" value="0"> </label>
            <label>å¡«ç©ºé¢˜ <input type="number" min="0" max="25" name="fill" value="0"> </label>
            <label>é—®ç­”é¢˜ <input type="number" min="0" max="25" name="short" value="0"> </label>
            <button type="button" class="btn btn-success pull-right" id="btn-generate">ç”Ÿæˆé¢˜ç›®</button>

        </div>

   

        <div id="question-preview"></div>
        <div class="form-group">
            <button type="button" class="btn btn-primary" id="btn-insert-all">ğŸ“¥ ä¸€é”®æ·»åŠ å…¨éƒ¨é¢˜ç›®</button>
        </div>
        
    </form>
</div>

<script>
    $(function () {
        // ç¤ºä¾‹ç‚¹å‡»å¡«å……
        $('.tag-sample').click(function () {
            $('textarea[name="prompt"]').val($(this).text());
        });


        
    
        let questions = []; // å…¨å±€å˜é‡ä¿å­˜ AI è¿”å›çš„é¢˜ç›®æ•°ç»„

        // ç”ŸæˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('#btn-generate').click(function () {
            var formData = $('#ai-form').serialize();
            Fast.api.ajax({
                url: 'exam/question/doAIGenerate',
                data: $('#ai-form').serialize()
            }, function (data,res) {
                // âœ… æ­¤æ—¶ data æ˜¯ data.questions
                questions = data.questions; // æ­£ç¡®ï¼

                var html = '';

                questions.forEach(function (q, index) {
                    html += '<div class="panel panel-default" style="margin-bottom:10px;">';
                    html += '<div class="panel-heading">ç¬¬ ' + (index + 1) + ' é¢˜ï¼ˆ' + q.kind + 'ï¼‰</div>';
                    html += '<div class="panel-body">';
                    html += '<p><strong>é¢˜å¹²ï¼š</strong> ' + q.title + '</p>';

                    // æ¸²æŸ“é€‰é¡¹ï¼ˆä»…é™ SINGLE / MULTIï¼‰
                    if (q.kind === 'SINGLE' || q.kind === 'MULTI') {
                        html += '<ul class="option-list">';
                        q.options.forEach(function (opt, i) {
                            html += '<li>'  + opt + '</li>';
                        });
                        html += '</ul>';
                    }

                    html += '<p><strong>ç­”æ¡ˆï¼š</strong> ' + q.answer + '</p>';
                    html += '<p><strong>è§£æï¼š</strong> ' + q.explanation + '</p>';
                    html += `<button class="btn btn-success btn-insert" data-index="${index}">æ·»åŠ </button>`;
                    
                    html += '</div></div>';
                });

                $('#question-preview').html(html);
                return false; // é˜²æ­¢å…³é—­çª—å£
            });

        });
    
        function insertQuestion(q, $btn) {
            return new Promise((resolve) => {
                const keys = ['A', 'B', 'C', 'D', 'E', 'F'];
                const options = {};
                let answerKey = '';
                let title_fill = '';
                let fillAnswerArray = [];

                if (q.kind === 'SINGLE' || q.kind === 'MULTI') {
                    const answerKeys = [];
                    q.options.forEach((opt, i) => {
                        const key = keys[i];
                        options[key] = opt;

                        if (typeof q.answer === 'string') {
                            const answerArr = q.answer.split(',').map(a => a.trim().toLowerCase());
                            if (answerArr.includes(opt.trim().toLowerCase())) {
                                answerKeys.push(key);
                            }
                        } else if (Array.isArray(q.answer)) {
                            if (q.answer.includes(opt)) {
                                answerKeys.push(key);
                            }
                        }
                    });

                    answerKey = answerKeys.join(',');
                } else if (q.kind === 'FILL') {
                    // âœ… å¡«ç©ºé¢˜ç‰¹æ®Šå¤„ç†
                    title_fill = q.title || '';

                    // æ„å»ºå¡«ç©ºé¢˜ç­”æ¡ˆæ•°ç»„ï¼ˆæ”¯æŒå•ç©ºæˆ–å¤šç©ºï¼‰
                    if (typeof q.answer === 'string') {
                        const blanks = q.answer.split(',').map(item => item.trim());
                        fillAnswerArray = blanks.map(ans => ({ answers: [ans] }));
                    } else if (Array.isArray(q.answer)) {
                        fillAnswerArray = q.answer.map(ans => ({ answers: [ans] }));
                    }

                    answerKey = ''; // å¡«ç©ºé¢˜ä¸éœ€è¦ä¸» answer å­—ç¬¦ä¸²
                } else {
                    // åˆ¤æ–­é¢˜/ç®€ç­”é¢˜
                    answerKey = q.answer;
                }

                // åŸºæœ¬å­—æ®µæ ¡éªŒ
                if (!answerKey && q.kind !== 'FILL') {
                    Toastr.error('æœªèƒ½åŒ¹é…ç­”æ¡ˆé€‰é¡¹ï¼Œè¯·æ£€æŸ¥ AI è¿”å›å†…å®¹');
                    resolve(false);
                    return;
                }

                const postData = {
                    row: {
                        cate_id: $('#c-cate_id').val(),
                        title: q.title,
                        kind: q.kind,
                        options_json: (q.kind === 'SINGLE' || q.kind === 'MULTI') ? JSON.stringify(options) : '',
                        answer: (q.kind === 'FILL') ? fillAnswerArray : answerKey,
                        explain: q.explanation,
                        difficulty: 'GENERAL',
                        status: 'NORMAL',
                        is_material_child: 0,
                        material_question_id: '',
                        material_question_id_text: '',
                        material_score: 0,
                        options_img: '',
                        short_answer: '',
                        title_fill: title_fill,
                        title_video: '',
                        explain_video: '',
                        material_questions: ''
                    }
                };

                Fast.api.ajax({
                    url: 'exam/question/add',
                    data: postData,
                    method: 'POST'
                }, function () {
                    if ($btn) {
                        $btn.prop('disabled', true).text('âœ… å·²æ·»åŠ ');
                    }
                    resolve(true);
                }, function () {
                    Toastr.error('æ·»åŠ å¤±è´¥');
                    resolve(false);
                });
            });
        }







        $(document).off('click', '.btn-insert').on('click', '.btn-insert', function (e) {
            e.preventDefault(); // ğŸ‘ˆ é˜»æ­¢è¡¨å•é»˜è®¤æäº¤

            const index = $(this).data('index');
            const q = questions[index];
            if (!q) {
                Toastr.error('é¢˜ç›®æ•°æ®ä¸å­˜åœ¨');
                return;
            }

            insertQuestion(q, $(this));
        });

     

        // ä¸€é”®å…¨éƒ¨æ’å…¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('#btn-insert-all').click(async function () {
            if (!questions.length) {
                Toastr.warning('è¯·å…ˆç”Ÿæˆé¢˜ç›®');
                return;
            }

            $(this).prop('disabled', true).text('â³ æ­£åœ¨æ‰¹é‡æ·»åŠ ...');

            let successCount = 0;

            for (let i = 0; i < questions.length; i++) {
                const q = questions[i];
                const $btn = $(`.btn-insert[data-index="${i}"]`);
                  // âœ… å¦‚æœæŒ‰é’®å·²ç¦ç”¨ï¼Œè¯´æ˜å·²ç»å•ç‹¬æ·»åŠ è¿‡ï¼Œè·³è¿‡
                if ($btn.prop('disabled')) {
                    continue;
                }
                const ok = await insertQuestion(q, $btn);
                if (ok) successCount++;
            }

            Toastr.success(`âœ… æ·»åŠ å®Œæˆï¼ŒæˆåŠŸ ${successCount}/${questions.length} é¢˜`);
            $(this).prop('disabled', false).text('ä¸€é”®æ·»åŠ å…¨éƒ¨');
        });


    });
    </script>
    